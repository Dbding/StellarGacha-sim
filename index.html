<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ˜Ÿè¾°å åœæ±  - è§’è‰²å¬å–š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0c0a1e; color: #e0e0e0; overflow: hidden; transition: background-color 0.5s ease; -webkit-tap-highlight-color: transparent; }
        .rarity-n { border-color: #a0a0a0; box-shadow: 0 0 5px #a0a0a0; }
        .rarity-r { border-color: #6495ed; box-shadow: 0 0 8px #6495ed; }
        .rarity-sr { border-color: #ffd700; box-shadow: 0 0 12px #ffd700; }
        .rarity-ssr { border-color: #ff4500; box-shadow: 0 0 18px #ff4500; animation: pulse-ssr 2s infinite; }
        .rarity-ur { border-color: #da70d6; box-shadow: 0 0 25px #da70d6, 0 0 10px #ff00ff inset; animation: pulse-ur 1.5s infinite; }
        .rarity-uur { border-image: linear-gradient(45deg, gold, deeppink, lightseagreen, gold) 1; border-width: 3px; border-style: solid; animation: pulse-uur 1s infinite; }
        
        .text-rarity-n { color: #a0a0a0; } .text-rarity-r { color: #6495ed; } .text-rarity-sr { color: #ffd700; } .text-rarity-ssr { color: #ff4500; } .text-rarity-ur { color: #da70d6; }
        .text-rarity-uur { background: linear-gradient(45deg, gold, deeppink, lightseagreen); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: text-rainbow 2s linear infinite; }

        @keyframes pulse-ssr { 0% { box-shadow: 0 0 18px #ff4500; } 50% { box-shadow: 0 0 25px #ff8c00; } 100% { box-shadow: 0 0 18px #ff4500; } }
        @keyframes pulse-ur { 0% { transform: scale(1); box-shadow: 0 0 25px #da70d6, 0 0 10px #ff00ff inset; } 50% { transform: scale(1.02); box-shadow: 0 0 35px #ff00ff, 0 0 15px #ffffff inset; } 100% { transform: scale(1); box-shadow: 0 0 25px #da70d6, 0 0 10px #ff00ff inset; } }
        @keyframes pulse-uur { 0% { transform: scale(1.02); } 50% { transform: scale(1.05); } 100% { transform: scale(1.02); } }
        @keyframes text-rainbow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes star-glow { 0%, 100% { box-shadow: 0 0 15px 3px #fff, 0 0 25px 8px #ffd700, 0 0 35px 15px #ff8c00; opacity: 0.8; } 50% { box-shadow: 0 0 20px 5px #fff, 0 0 35px 12px #ffd700, 0 0 50px 20px #ff8c00; opacity: 1; } }

        #divinationCanvas { cursor: crosshair; background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); }
        
        .card-on-canvas { animation: card-reveal-on-canvas 0.7s ease-out forwards; opacity: 0; }
        @keyframes card-reveal-on-canvas {
            0% { opacity: 0; transform: perspective(500px) rotateY(-100deg) scale(0.7); }
            70% { opacity: 1; transform: perspective(500px) rotateY(10deg) scale(1.05); }
            100% { opacity: 1; transform: perspective(500px) rotateY(0deg) scale(1); }
        }
        
        @keyframes screen-shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } 20%, 40%, 60%, 80% { transform: translateX(8px); } }
        @keyframes screen-shake-hard { 0%, 100% { transform: translate(0, 0) rotate(0); } 10%, 50%, 90% { transform: translate(-12px, 8px) rotate(-2deg); } 30%, 70% { transform: translate(12px, -8px) rotate(2deg); } }
        .shake-animation { animation: screen-shake 0.5s ease-in-out; }
        .shake-animation-hard { animation: screen-shake-hard 0.6s ease-in-out; }
        
        .grayscale { filter: grayscale(100%); }
        .fragment-toast { animation: float-up 1.5s ease-out forwards; }
        @keyframes float-up { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-50px); } }
        
        .rarity-flash-overlay { animation: flash-effect 1.2s ease-out forwards; }
        @keyframes flash-effect { from { opacity: 0.7; } to { opacity: 0; } }

        .star-max-glow { animation: star-glow 2.5s infinite; }
        .star-rating { color: #ffd700; text-shadow: 0 0 3px #ffd700; }
        
        .toast-notification { animation: fade-in-out 2s ease-in-out forwards; }
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(20px) translateX(-50%); }
            10% { opacity: 1; transform: translateY(0) translateX(-50%); }
            90% { opacity: 1; transform: translateY(0) translateX(-50%); }
            100% { opacity: 0; transform: translateY(-20px) translateX(-50%); }
        }

        .rapid-tap-zone { transition: background-color 0.2s; }
        .rapid-tap-zone:active { background-color: rgba(255, 255, 0, 0.2); }
        
        /* Hide scrollbar for achievement tabs */
        #achievement-tabs::-webkit-scrollbar { display: none; }
        #achievement-tabs { -ms-overflow-style: none; scrollbar-width: none; }


        /* Pudding Theme */
        .pudding-mode { background-color: #FFD166; }
        .pudding-mode #main-container { background-color: #FFF8E1; border-color: #8D6E63; color: #6D4C41; }
        .pudding-mode header h1 { background-image: linear-gradient(to right, #D1913C, #FFD194); }
        .pudding-mode header p, .pudding-mode #main-container .text-slate-300 { color: #A1887F; }
        .pudding-mode .bg-slate-800\/50 { background-color: #F5E8C7; }
        .pudding-mode .font-bold.text-purple-300 { color: #8D6E63; }
        .pudding-mode #draw-1 { background-image: linear-gradient(to right, #FFB347, #FFCC33); }
        .pudding-mode #draw-10 { background-image: linear-gradient(to right, #FFA726, #FFB74D); }
        .pudding-mode #draw-fragment-1, .pudding-mode #draw-fragment-3 { background-image: linear-gradient(to right, #D1913C, #FFD194); }
        .pudding-mode #claim-daily-btn, .pudding-mode #luck-btn, .pudding-mode #claim-fragment-btn { background-color: #A1887F; }
        .pudding-mode #claim-daily-btn:hover, .pudding-mode #luck-btn:hover, .pudding-mode #claim-fragment-btn:hover { background-color: #8D6E63; }
        .pudding-mode #canvas-container { border-color: #A1887F; }
        .pudding-mode .card-on-canvas { background-color: #fffaf0; }
        .pudding-mode .text-white\/70, .pudding-mode .text-slate-400, .pudding-mode .text-slate-500 { color: #8D6E63; }
        .pudding-mode #canvas-stats-top-left, .pudding-mode #canvas-stats-bottom-left, .pudding-mode #canvas-stats-top-right { color: #8D6E63; }
        .pudding-mode #canvas-stats-top-left .text-purple-300, .pudding-mode #canvas-stats-bottom-left .text-purple-300, .pudding-mode #canvas-stats-top-right .text-purple-300 { color: #6D4C41; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="rarity-flash-overlay" class="fixed inset-0 z-[100] pointer-events-none opacity-0"></div>

    <div id="main-container" class="relative w-full max-w-4xl mx-auto bg-slate-900/50 rounded-2xl shadow-2xl p-4 sm:p-6 border border-slate-700 transition-transform duration-500">
        <div class="absolute top-4 left-6 flex items-center space-x-4 z-10">
            <p class="text-lg sm:text-xl font-bold text-white/70 select-none">ä½œè€…ï¼šç›¯å¸ƒä¸</p>
            <button id="collection-btn" class="text-slate-400 hover:text-white transition-colors" title="åœ–é‘‘"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 16c1.255 0 2.443-.29 3.5-.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 0114.5 16c1.255 0 2.443-.29 3.5-.804v-10A7.968 7.968 0 0014.5 4z" /></svg></button>
            <button id="history-btn" class="text-slate-400 hover:text-white transition-colors" title="å¬å–šæ­·å²"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg></button>
            <button id="achievement-btn" class="relative text-slate-400 hover:text-white transition-colors" title="æˆå°±"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0L8 7.152l-4.242.618c-1.634.238-2.29 2.242-1.088 3.422l3.07 2.99- .724 4.225c-.28 1.625 1.423 2.863 2.914 2.153L10 17.677l3.77 1.982c1.49.71 3.192-.528 2.912-2.153l-.724-4.225 3.07-2.99c1.202-1.18 1.546-3.184-1.088-3.422L12 7.152l-.51-4.002z" clip-rule="evenodd" /></svg><div id="achievement-red-dot" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-slate-900 hidden"></div></button>
            <button id="reset-btn" class="text-slate-400 hover:text-white transition-colors" title="é‡ç½®éŠæˆ²"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg></button>
        </div>
        <div class="absolute top-4 right-4 flex items-center space-x-3 z-10">
            <button id="info-btn" class="text-slate-400 hover:text-white transition-colors" title="å¬å–šè©³æƒ…"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></button>
        </div>
        <header class="text-center mb-2 pt-8"><h1 class="text-3xl sm:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-cyan-300">æ˜Ÿè¾°å åœæ± </h1><p class="text-slate-400 mt-1">æç¹ªä½ çš„å‘½é‹ï¼Œå¬å–šå‚³èªªä¸­çš„è‹±é›„</p><p id="date-display" class="text-slate-500 text-sm mt-1"></p></header>
        
        <div class="flex flex-wrap items-center justify-center gap-y-2 gap-x-4 sm:gap-x-6 mb-4">
            <div class="flex items-center space-x-2 bg-slate-800/50 px-3 py-1 rounded-full"><span class="text-yellow-400 text-lg">ğŸ’</span><span id="stardust-stones-counter" class="text-lg sm:text-xl font-bold text-white">3000</span><span class="text-slate-300">æ˜Ÿå¡µçŸ³</span></div>
            <div class="flex items-center space-x-2 bg-slate-800/50 px-3 py-1 rounded-full"><span class="text-cyan-400 text-lg">âœ¨</span><span id="fragments-counter" class="text-lg sm:text-xl font-bold text-white">0</span><span class="text-slate-300">ç¢ç‰‡</span></div>
        </div>

        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
            <button id="claim-daily-btn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">æ¯æ—¥é ˜å–</button>
            <button id="luck-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg transition-colors">çµç®—æœ¬æ—¥é‹å‹¢</button>
            <button id="claim-fragment-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">é ˜å–ç¢ç‰‡ (30s)</button>
            <div id="rapid-click-container" class="relative w-full h-full bg-yellow-600/20 rounded-lg flex items-center justify-center text-yellow-300 font-bold overflow-hidden select-none">
                <div id="rapid-tap-left-btn" class="absolute left-0 top-0 w-1/2 h-full rapid-tap-zone"></div>
                <div id="rapid-tap-right-btn" class="absolute right-0 top-0 w-1/2 h-full rapid-tap-zone border-l border-yellow-500/30"></div>
                <span id="rapid-click-text">æ˜Ÿè¾°çˆ†ç™¼ (0/10)</span>
            </div>
        </div>
        
        <div id="canvas-container" class="relative w-full aspect-video rounded-lg overflow-hidden border-2 border-purple-500/30 mb-4 shadow-lg">
            <canvas id="divinationCanvas"></canvas>
            <div id="canvas-overlay" class="absolute inset-0 flex items-center justify-center bg-black/50 pointer-events-none"><p class="text-xl font-bold text-white/80 animate-pulse">è«‹åœ¨æ­¤è™•æ‹–æ›³ï¼Œé€£çµæ˜Ÿè¾°...</p></div>
            <button id="skip-animation-btn" class="absolute bottom-4 right-4 bg-white/20 text-white font-bold py-2 px-4 rounded-lg backdrop-blur-sm hover:bg-white/30 transition-colors z-20 hidden">è·³é</button>
            <div id="canvas-stats-top-left" class="absolute top-2 left-2 text-white/80 text-xs sm:text-sm bg-black/20 p-2 rounded-md backdrop-blur-sm pointer-events-none"><h3 class="font-bold text-purple-300">ä¿åº•</h3><p>SR+: <span id="canvas-sr-pity" class="font-bold text-yellow-400">0</span>/10</p><p>SSR+: <span id="canvas-ssr-pity" class="font-bold text-orange-400">0</span><span id="canvas-ssr-pity-max">/30</span></p></div>
            <div id="canvas-stats-bottom-left" class="absolute bottom-2 left-2 text-white/80 text-xs sm:text-sm bg-black/20 p-2 rounded-md backdrop-blur-sm pointer-events-none"><h3 class="font-bold text-purple-300">ç´¯è¨ˆå¬å–š</h3><p class="text-lg sm:text-xl font-bold text-cyan-300" id="canvas-total-pulls">0</p></div>
            <div id="canvas-stats-top-right" class="absolute top-2 right-2 text-white/80 text-xs sm:text-sm bg-black/20 p-2 rounded-md backdrop-blur-sm text-right pointer-events-none"><h3 class="font-bold text-purple-300">çµ±è¨ˆ</h3><div class="grid grid-cols-2 gap-x-2"><p>N: <span id="canvas-n-stat" class="font-bold text-gray-400">0</span></p><p>R: <span id="canvas-r-stat" class="font-bold text-blue-400">0</span></p><p>SR: <span id="canvas-sr-stat" class="font-bold text-yellow-400">0</span></p><p>SSR: <span id="canvas-ssr-stat" class="font-bold text-orange-400">0</span></p><p>UR: <span id="canvas-ur-stat" class="font-bold text-violet-400">0</span></p><p>UUR: <span id="canvas-uur-stat" class="font-bold text-rarity-uur">0</span></p></div></div>
        </div>
        
        <div class="my-4 space-y-3">
            <div class="flex w-full space-x-3"><button id="draw-1" class="w-1/2 bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:scale-105 transition-transform duration-200 disabled:opacity-50 disabled:cursor-not-allowed"></button><button id="draw-10" class="w-1/2 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:scale-105 transition-transform duration-200 disabled:opacity-50 disabled:cursor-not-allowed"></button></div>
            <div class="flex w-full space-x-3"><button id="draw-fragment-1" class="w-1/2 bg-gradient-to-r from-cyan-500 to-teal-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:scale-105 transition-transform duration-200 disabled:opacity-50 disabled:cursor-not-allowed"></button><button id="draw-fragment-3" class="w-1/2 bg-gradient-to-r from-cyan-600 to-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:scale-105 transition-transform duration-200 disabled:opacity-50 disabled:cursor-not-allowed"></button></div>
        </div>
    </div>
    <div id="hall-of-legends-container" class="w-full max-w-4xl mx-auto mt-8 p-4 bg-slate-900/50 rounded-2xl border border-yellow-400/50 shadow-2xl hidden"><h2 class="text-3xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-orange-400 mb-4">å‚³èªªæ®¿å ‚</h2><div id="hall-of-legends-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div></div>
    
    <!-- Modals -->
    <div id="info-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden"><div class="w-full max-w-2xl bg-slate-800 rounded-lg shadow-lg p-6 relative border border-slate-600"><button id="close-info-modal-btn" class="absolute top-3 right-3 text-slate-400 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 class="text-2xl font-bold text-center mb-4 text-cyan-300">å¬å–šè©³æƒ…</h2><div id="info-modal-body" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div></div></div>
    <div id="history-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden"><div class="w-full max-w-2xl bg-slate-800 rounded-lg shadow-lg p-6 relative border border-slate-600"><button id="close-history-modal-btn" class="absolute top-3 right-3 text-slate-400 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 class="text-2xl font-bold text-center mb-4 text-cyan-300">å¬å–šæ­·å²</h2><div id="history-modal-body" class="space-y-2 max-h-[60vh] overflow-y-auto pr-2"></div></div></div>
    <div id="collection-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden"><div class="w-full max-w-4xl bg-slate-800 rounded-lg shadow-lg p-6 relative border border-slate-600"><button id="close-collection-modal-btn" class="absolute top-3 right-3 text-slate-400 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 class="text-2xl font-bold text-center mb-4 text-cyan-300">è§’è‰²åœ–é‘‘</h2><div id="collection-modal-body" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div></div></div>
    <div id="luck-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden"><div class="w-full max-w-md bg-slate-800 rounded-lg shadow-lg p-6 relative border border-slate-600 text-center"><button id="close-luck-modal-btn" class="absolute top-3 right-3 text-slate-400 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button><h2 class="text-2xl font-bold text-center mb-4 text-cyan-300">æœ¬æ—¥é‹å‹¢</h2><div id="luck-modal-body" class="space-y-2"></div></div></div>
    <div id="achievement-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden"><div class="w-full max-w-3xl bg-slate-800 rounded-lg shadow-lg p-6 relative border border-slate-600 flex flex-col" style="height: 90vh; max-height: 800px;"><div class="flex items-center justify-between mb-4 flex-shrink-0"><h2 class="text-2xl font-bold text-cyan-300">æˆå°±æ®¿å ‚</h2><button id="claim-all-achievements-btn" class="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-5 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">ä¸€éµé ˜å–</button><button id="close-achievement-modal-btn" class="absolute top-3 right-3 text-slate-400 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button></div><div id="achievement-modal-body" class="flex-grow min-h-0 flex flex-col"></div></div></div>
    <div id="reset-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 hidden"><div class="w-full max-w-md bg-slate-800 rounded-lg shadow-lg p-6 relative border border-red-500 text-center"><h2 class="text-2xl font-bold text-center mb-4 text-red-400">é‡ç½®éŠæˆ²</h2><p class="text-slate-300 mb-6">æ‚¨ç¢ºå®šè¦é‡ç½®æ‰€æœ‰éŠæˆ²é€²åº¦å—ï¼Ÿ<br>é€™å€‹æ“ä½œç„¡æ³•å¾©åŸï¼</p><div class="flex justify-center space-x-4"><button id="cancel-reset-btn" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">å–æ¶ˆ</button><button id="confirm-reset-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition-colors">ç¢ºå®šé‡ç½®</button></div></div></div>

    <script>
        // --- è³‡æ–™è¨­å®š ---
        const CHARACTERS = {
            N: { characters: ['å²èŠå§†', 'å“¥å¸ƒæ—', 'å°å¦–ç²¾', 'é‡ç‹¼', 'å·¨å¤§è™è ', 'åŠ‡æ¯’èœ˜è››', 'æ´ç©´åœ°ç²¾'], maxStars: 2 },
            R: { characters: ['è¦‹ç¿’é¨å£«', 'é­”æ³•å­¸å¾’', 'ç²¾éˆå°„æ‰‹', 'ç¸äººæˆ°å£«', 'çŸ®äººç¤¦å·¥', 'è¦‹ç¿’ç‰§å¸«', 'æµæµªç›œè³Š'], maxStars: 3 },
            SR: { characters: ['çš‡å®¶é¨å£«åœ˜é•·', 'å¤§é­”å°å¸«', 'æœˆå…‰ç¥­å¸', 'æš—å½±åˆºå®¢', 'ç…é·²é¨å£«', 'è–æ®¿é¨å£«', 'é¾è£”æˆ°å£«', 'å…ƒç´ ä½¿'], maxStars: 4 },
            SSR: { characters: ['ç‚é¾é¨å£«', 'æ·±æ·µé­”ç‹', 'è–å…‰å¥³ç¥', 'æ™‚ç©ºå¤§æ³•å¸«', 'é¢¨æš´å°„æ‰‹'], maxStars: 5 },
            UR: { characters: [{ id: 1, name: 'å‰µä¸–ä¹‹ç¥ï¼ä¼Šè‰è‹Ÿçµ²', title: 'è¬ç‰©ä¹‹å§‹' }, { id: 2, name: 'æ»…ä¸–é­”é¾ï¼å·´å“ˆå§†ç‰¹', title: 'çµ‚ç„‰ä¹‹æ¯' }, { id: 3, name: 'æ˜Ÿéš›æ—…äººï¼å‡±æ©', title: 'æ™‚ç©ºæ¼«éŠè€…' }], maxStars: 5 },
            UUR: { characters: [{ id: 101, name: 'å¸ƒä¸', title: 'è¬ç‰©çš„çœŸç†' }], maxStars: 5 }
        };
        const PROBABILITIES = { UR: 0.004, SSR: 0.020, SR: 0.123, R: 0.492, N: 0.361 };
        const PROBABILITIES_FRAGMENT = { UUR: 0.05, UR: 0.25, SSR: 0.70 };
        const PITY_CONFIG = { SR: 10, SSR: 30 };
        const DRAW_COST = { single: 80, multi: 800, fragmentSingle: 120, fragmentMulti: 360 };
        const FRAGMENT_REWARDS = { N: 1, R: 5, SR: 20, SSR: 60, UR: 150, UUR: 200 };
        const DAILY_REWARD = 3000;
        const CONSTELLATION_ADJECTIVES = ['æ²‰ç¡çš„', 'é–ƒè€€çš„', 'æ‚²å‚·çš„', 'å–œæ‚…çš„', 'æµæµªçš„', 'å®ˆè­·çš„', 'ä½èªçš„', 'ç‡ƒç‡’çš„', 'ç„¡å çš„', 'è© å”±çš„', 'ç ´ç¢çš„', 'æ°¸æ†çš„', 'éºå¿˜çš„', 'å‘¢å–ƒçš„'];
        const CONSTELLATION_NOUNS = ['ç¨è§’ç¸', 'çµæˆ¶', 'ç‹‚èŸ¹', 'é³³å‡°', 'å¤©é¦¬', 'è±ç´', 'ç¾…ç›¤', 'æ™‚é˜', 'é‘°åŒ™', 'ç‹å† ', 'æ–¹å°–ç¢‘', 'æ²™æ¼', 'è¿·å®®', 'ä¸–ç•Œæ¨¹'];
        const TOTAL_CHARACTER_COUNT = Object.values(CHARACTERS).reduce((sum, rarity) => sum + rarity.characters.length, 0);

        // --- ç‹€æ…‹ç®¡ç† ---
        let pityCounters, rarityCounts, characterCollection, gachaHistory, totalPulls, stardustStones, fragments, achievements;
        let luckCalculations, fragmentClaims, historyViews, infoViews, ssrPityTriggered, fragmentSummons, dailyClaims, skipAnimationUses, totalStonesSpent, maxConstellationPoints;
        let noSsrStreak, pullsInPuddingMode;
        let isDrawingAnimation = false;
        let animationFrameId = null;
        let animationResolve = null;
        let animationHighestRarity = null;
        let isPuddingModeActive = false;
        let fragmentClaimTimer = 30;
        let fragmentClaimIntervalId = null;
        let rapidClickCount = 0, rapidClickTimerId = null, isRapidClickOnCooldown = false, rapidClickCooldownTimer = 60, lastTapArea = null;

        // --- DOM å…ƒç´  ---
        const dom = {
            body: document.body, mainContainer: document.getElementById('main-container'), rarityFlashOverlay: document.getElementById('rarity-flash-overlay'),
            canvas: document.getElementById('divinationCanvas'), canvasContainer: document.getElementById('canvas-container'), canvasOverlay: document.getElementById('canvas-overlay'),
            draw1Btn: document.getElementById('draw-1'), draw10Btn: document.getElementById('draw-10'), drawFragmentBtn1: document.getElementById('draw-fragment-1'), drawFragmentBtn3: document.getElementById('draw-fragment-3'),
            hallOfLegendsContainer: document.getElementById('hall-of-legends-container'), hallOfLegendsGrid: document.getElementById('hall-of-legends-grid'),
            infoBtn: document.getElementById('info-btn'), infoModal: document.getElementById('info-modal'), closeInfoModalBtn: document.getElementById('close-info-modal-btn'), infoModalBody: document.getElementById('info-modal-body'),
            historyBtn: document.getElementById('history-btn'), historyModal: document.getElementById('history-modal'), closeHistoryModalBtn: document.getElementById('close-history-modal-btn'), historyModalBody: document.getElementById('history-modal-body'),
            collectionBtn: document.getElementById('collection-btn'), collectionModal: document.getElementById('collection-modal'), closeCollectionModalBtn: document.getElementById('close-collection-modal-btn'), collectionModalBody: document.getElementById('collection-modal-body'),
            luckBtn: document.getElementById('luck-btn'), luckModal: document.getElementById('luck-modal'), closeLuckModalBtn: document.getElementById('close-luck-modal-btn'), luckModalBody: document.getElementById('luck-modal-body'),
            achievementBtn: document.getElementById('achievement-btn'), achievementModal: document.getElementById('achievement-modal'), closeAchievementModalBtn: document.getElementById('close-achievement-modal-btn'), achievementModalBody: document.getElementById('achievement-modal-body'), achievementRedDot: document.getElementById('achievement-red-dot'),
            claimAllAchievementsBtn: document.getElementById('claim-all-achievements-btn'),
            resetBtn: document.getElementById('reset-btn'), resetModal: document.getElementById('reset-modal'), confirmResetBtn: document.getElementById('confirm-reset-btn'), cancelResetBtn: document.getElementById('cancel-reset-btn'),
            stardustStonesCounter: document.getElementById('stardust-stones-counter'), fragmentsCounter: document.getElementById('fragments-counter'),
            claimDailyBtn: document.getElementById('claim-daily-btn'), claimFragmentBtn: document.getElementById('claim-fragment-btn'), 
            rapidClickContainer: document.getElementById('rapid-click-container'), rapidClickText: document.getElementById('rapid-click-text'), rapidTapLeftBtn: document.getElementById('rapid-tap-left-btn'), rapidTapRightBtn: document.getElementById('rapid-tap-right-btn'),
            skipAnimationBtn: document.getElementById('skip-animation-btn'), dateDisplay: document.getElementById('date-display'),
            canvasSrPity: document.getElementById('canvas-sr-pity'), canvasSsrPity: document.getElementById('canvas-ssr-pity'), canvasSsrPityMax: document.getElementById('canvas-ssr-pity-max'),
            canvasTotalPulls: document.getElementById('canvas-total-pulls'),
            canvasNStat: document.getElementById('canvas-n-stat'), canvasRStat: document.getElementById('canvas-r-stat'), canvasSrStat: document.getElementById('canvas-sr-stat'), canvasSsrStat: document.getElementById('canvas-ssr-stat'), canvasUrStat: document.getElementById('canvas-ur-stat'), canvasUurStat: document.getElementById('canvas-uur-stat'),
        };
        const ctx = dom.canvas.getContext('2d');

        // --- æ˜Ÿç©ºç•«å¸ƒ ---
        let stars = [], isDrawing = false, constellationPoints = [], particles = [];
        function resizeCanvas() { dom.canvas.width = dom.canvasContainer.clientWidth; dom.canvas.height = dom.canvasContainer.clientHeight; }
        function generateStars(count) { stars = []; for (let i = 0; i < count; i++) { stars.push({ x: Math.random() * dom.canvas.width, y: Math.random() * dom.canvas.height, radius: Math.random() * 1.5 + 0.5, alpha: Math.random() * 0.5 + 0.5 }); } }
        function drawStars() { ctx.clearRect(0, 0, dom.canvas.width, dom.canvas.height); stars.forEach(star => { ctx.beginPath(); ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2); ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`; ctx.fill(); }); }
        function drawConstellation(stroke) { if (constellationPoints.length < 2) return; ctx.beginPath(); ctx.moveTo(constellationPoints[0].x, constellationPoints[0].y); for (let i = 1; i < constellationPoints.length; i++) { ctx.lineTo(constellationPoints[i].x, constellationPoints[i].y); } ctx.strokeStyle = stroke || 'rgba(255, 255, 255, 0.7)'; ctx.lineWidth = 2; ctx.shadowColor = 'white'; ctx.shadowBlur = 10; ctx.stroke(); ctx.shadowBlur = 0; }
        
        class Particle {
            constructor(x, y, color) { this.x = x; this.y = y; this.color = color; this.size = Math.random() * 5 + 2; this.life = 1; const angle = Math.random() * Math.PI * 2; const speed = Math.random() * 4 + 1; this.vx = Math.cos(angle) * speed; this.vy = Math.sin(angle) * speed; }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; this.size *= 0.98; }
            draw() { ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1; }
        }
        function createParticleBurst(x, y, color, count) { for (let i = 0; i < count; i++) { particles.push(new Particle(x, y, color)); } }
        function handleParticles() { for (let i = particles.length - 1; i >= 0; i--) { particles[i].update(); particles[i].draw(); if (particles[i].life <= 0) { particles.splice(i, 1); } } }

        // --- æŠ½å¡æ ¸å¿ƒé‚è¼¯ ---
        function getRarity(probSet, isSrPity = false, isSsrPity = false) { if (probSet === PROBABILITIES) { if (isSsrPity) return Math.random() < (probSet.UR / (probSet.UR + probSet.SSR)) ? 'UR' : 'SSR'; if (isSrPity) { const srPlusProb = probSet.SR + probSet.SSR + probSet.UR; const rand = Math.random(); if (rand < probSet.UR / srPlusProb) return 'UR'; if (rand < (probSet.UR + probSet.SSR) / srPlusProb) return 'SSR'; return 'SR'; } } const rand = Math.random(); let cumulative = 0; for (const rarity in probSet) { cumulative += probSet[rarity]; if (rand < cumulative) { return rarity; } } return 'SSR'; }
        function drawOneCharacter(probSet, isSrPity = false, isSsrPity = false) { const rarity = getRarity(probSet, isSrPity, isSsrPity); let character; const charactersOfRarity = CHARACTERS[rarity].characters; if (rarity === 'UR' || rarity === 'UUR') { character = { ...charactersOfRarity[Math.floor(Math.random() * charactersOfRarity.length)] }; } else { const name = charactersOfRarity[Math.floor(Math.random() * charactersOfRarity.length)]; character = { name }; } if (probSet === PROBABILITIES) { if (rarity === 'UR' || rarity === 'SSR') { pityCounters.ssr = 0; pityCounters.sr = 0; } else if (rarity === 'SR') { pityCounters.sr = 0; } } return { ...character, rarity }; }
        function processDraw(count, poolType) {
            if (isDrawingAnimation) return;
            const isFragmentPool = poolType === 'fragment';
            let cost;
            if (isFragmentPool) { cost = count === 1 ? DRAW_COST.fragmentSingle : DRAW_COST.fragmentMulti; } 
            else { cost = count === 1 ? DRAW_COST.single : DRAW_COST.multi; }
            const currency = isFragmentPool ? fragments : stardustStones;
            if (currency < cost) { alert(isFragmentPool ? 'ç¢ç‰‡ä¸è¶³ï¼' : 'æ˜Ÿå¡µçŸ³ä¸è¶³ï¼'); return; }
            if (constellationPoints.length < 3) { alert('è«‹å…ˆåœ¨æ˜Ÿç©ºä¸­ç¹ªè£½è‡³å°‘é€£çµ3é¡†æ˜Ÿçš„æ˜Ÿåº§ï¼'); return; }
            
            const startStones = stardustStones;
            maxConstellationPoints = Math.max(maxConstellationPoints, constellationPoints.length);

            if (isFragmentPool) { 
                fragments -= cost; 
                fragmentSummons += count;
            } else { 
                stardustStones -= cost; 
                totalStonesSpent += cost;
            }
            isDrawingAnimation = true;
            toggleButtons(false);

            const results = [];
            let hasHighRarity = false;
            for (let i = 0; i < count; i++) {
                if (!isFragmentPool) { 
                    totalPulls++; 
                    pityCounters.sr++; 
                    pityCounters.ssr++; 
                    if (pityCounters.ssr >= PITY_CONFIG.SSR) { ssrPityTriggered = true; }
                }
                const character = drawOneCharacter(isFragmentPool ? PROBABILITIES_FRAGMENT : PROBABILITIES, pityCounters.sr >= PITY_CONFIG.SR, pityCounters.ssr >= PITY_CONFIG.SSR);
                if (character.rarity === 'SSR' || character.rarity === 'UR' || character.rarity === 'UUR') { hasHighRarity = true; }
                const charIdentifier = character.id || character.name;
                
                const maxStarsForRarity = CHARACTERS[character.rarity].maxStars;
                if (characterCollection[charIdentifier]) { // Duplicate
                    character.isDuplicate = true;
                    if (characterCollection[charIdentifier].stars < maxStarsForRarity) { characterCollection[charIdentifier].stars++; }
                    const fragmentsGained = FRAGMENT_REWARDS[character.rarity];
                    fragments += fragmentsGained;
                    character.fragmentsGained = fragmentsGained;
                } else { // New character
                    character.isDuplicate = false;
                    characterCollection[charIdentifier] = { ...character, stars: 1 };
                }
                
                results.push(character);
                rarityCounts[character.rarity]++;
                if (character.rarity === 'UUR' && !isPuddingModeActive) {
                    activatePuddingMode();
                }
            }

            if (count >= 10 && !hasHighRarity) { noSsrStreak++; } else { noSsrStreak = 0; }
            if (isPuddingModeActive) { pullsInPuddingMode += count; }

            const endStones = stardustStones;
            gachaHistory.unshift({ date: new Date().toISOString(), results, isFragmentPool, startStones, endStones, constellationPoints: constellationPoints.length });
            if (gachaHistory.length > 50) gachaHistory.pop();
            results.sort((a, b) => { const order = { UUR: 6, UR: 5, SSR: 4, SR: 3, R: 2, N: 1 }; return order[b.rarity] - order[a.rarity]; });
            
            checkAchievements();
            saveData();

            dom.skipAnimationBtn.classList.remove('hidden');
            playConstellationAnimation(results[0].rarity).then(() => { 
                displayResultsOnCanvas(results); 
            });
        }
        
        // --- å‹•ç•« ---
        function endAnimation() {
            if (!animationResolve) return;
            if (constellationPoints.length > 0) {
                const center = constellationPoints.reduce((acc, p) => ({x: acc.x + p.x, y: acc.y + p.y}), {x: 0, y: 0});
                center.x /= constellationPoints.length; center.y /= constellationPoints.length;
                let strokeStyle;
                if (animationHighestRarity === 'UUR') { strokeStyle = `hsl(0, 100%, 70%)`; }
                else if (animationHighestRarity === 'UR') { strokeStyle = `hsl(300, 100%, 70%)`; }
                else if (animationHighestRarity === 'SSR') { strokeStyle = 'rgba(255, 69, 0, 0.9)'; }
                else if (animationHighestRarity === 'SR') { strokeStyle = 'rgba(255, 215, 0, 0.9)'; }
                else { strokeStyle = 'rgba(255, 255, 255, 0.7)'; }
                createParticleBurst(center.x, center.y, strokeStyle, 100);
                
                if (particles.length > 0 && !animationFrameId) {
                    function particleLoop() {
                        if (particles.length === 0) return;
                        drawStars(); handleParticles(); requestAnimationFrame(particleLoop);
                    }
                    particleLoop();
                }
            }
            constellationPoints = [];
            dom.skipAnimationBtn.classList.add('hidden');
            animationResolve();
            animationResolve = null;
            animationFrameId = null;
        }

        function playConstellationAnimation(highestRarity) {
            return new Promise(resolve => {
                animationResolve = resolve;
                animationHighestRarity = highestRarity;
                const rarityColors = { SSR: 'rgba(255, 69, 0, 0.9)', UR: 'rgba(218, 112, 214, 0.9)', UUR: 'linear-gradient(45deg, gold, deeppink, lightseagreen, gold)' };
                if (highestRarity in rarityColors) {
                    dom.rarityFlashOverlay.style.background = rarityColors[highestRarity];
                    dom.rarityFlashOverlay.classList.add('rarity-flash-overlay');
                    setTimeout(() => dom.rarityFlashOverlay.classList.remove('rarity-flash-overlay'), 1200);
                }
                if (highestRarity === 'UUR') { dom.mainContainer.classList.add('shake-animation-hard'); setTimeout(() => dom.mainContainer.classList.remove('shake-animation-hard'), 600); }
                else if (highestRarity === 'SSR' || highestRarity === 'UR') { dom.mainContainer.classList.add('shake-animation'); setTimeout(() => dom.mainContainer.classList.remove('shake-animation'), 500); }
                
                let startTime = null; const duration = 1500;
                function animate(timestamp) {
                    if (!startTime) startTime = timestamp; const progress = (timestamp - startTime) / duration; const glow = Math.sin(progress * Math.PI) * 30;
                    drawStars(); handleParticles();
                    let strokeStyle;
                    if (highestRarity === 'UUR') { const hue = (progress * 720) % 360; strokeStyle = `hsl(${hue}, 100%, 70%)`; ctx.shadowColor = strokeStyle; ctx.lineWidth = 5; }
                    else if (highestRarity === 'UR') { const hue = (progress * 360) % 360; strokeStyle = `hsl(${hue}, 100%, 70%)`; ctx.shadowColor = strokeStyle; ctx.lineWidth = 3; } 
                    else if (highestRarity === 'SSR') { strokeStyle = 'rgba(255, 69, 0, 0.9)'; ctx.shadowColor = 'rgba(255, 100, 0, 1)'; ctx.lineWidth = 3; } 
                    else if (highestRarity === 'SR') { strokeStyle = 'rgba(255, 215, 0, 0.9)'; ctx.shadowColor = 'rgba(255, 215, 0, 1)'; ctx.lineWidth = 3; } 
                    else { strokeStyle = 'rgba(255, 255, 255, 0.7)'; ctx.shadowColor = 'white'; ctx.lineWidth = 2; }
                    ctx.shadowBlur = glow; drawConstellation(strokeStyle); ctx.shadowBlur = 0;
                    if (progress >= 1) { endAnimation(); return; }
                    animationFrameId = requestAnimationFrame(animate);
                }
                animationFrameId = requestAnimationFrame(animate);
            });
        }

        // --- UI æ›´æ–° ---
        function displayResultsOnCanvas(results) {
            const container = dom.canvasContainer; const containerWidth = container.clientWidth;
            const cardCount = results.length; const maxCardsPerRow = 5; const gap = containerWidth * 0.02;
            let cardWidth = (containerWidth - (gap * (maxCardsPerRow + 1))) / maxCardsPerRow;
            if (cardCount < maxCardsPerRow && cardCount > 1) { cardWidth = (containerWidth - (gap * (cardCount + 1))) / cardCount; }
            if (cardWidth > 100) cardWidth = 100;
            const cardHeight = cardWidth * 1.2;

            results.forEach((char, index) => {
                const card = document.createElement('div');
                card.className = `absolute card-on-canvas border-2 rounded-lg p-2 text-center bg-slate-900/70 rarity-${char.rarity.toLowerCase()}`;
                card.style.width = `${cardWidth}px`; card.style.height = `${cardHeight}px`; card.style.animationDelay = `${index * 80}ms`;
                let row, col;
                if (cardCount <= maxCardsPerRow) { row = 0; col = index; const totalWidth = cardCount * cardWidth + (cardCount - 1) * gap; const startX = (containerWidth - totalWidth) / 2; card.style.left = `${startX + col * (cardWidth + gap)}px`; card.style.top = `${(container.clientHeight - cardHeight) / 2}px`;
                } else { const cardsInFirstRow = 5; const cardsInSecondRow = 5; if (index < cardsInFirstRow) { row = 0; col = index; const totalWidth = cardsInFirstRow * cardWidth + (cardsInFirstRow - 1) * gap; const startX = (containerWidth - totalWidth) / 2; card.style.left = `${startX + col * (cardWidth + gap)}px`; } else { row = 1; col = index - cardsInFirstRow; const totalWidth = cardsInSecondRow * cardWidth + (cardsInSecondRow - 1) * gap; const startX = (containerWidth - totalWidth) / 2; card.style.left = `${startX + col * (cardWidth + gap)}px`; } const totalHeight = 2 * cardHeight + gap; const startY = (container.clientHeight - totalHeight) / 2; card.style.top = `${startY + row * (cardHeight + gap)}px`; }
                card.innerHTML = `<p class="font-bold text-base">${char.rarity}</p><p class="text-sm">${char.name}</p>`;
                container.appendChild(card); 
                if (char.isDuplicate) { setTimeout(() => { card.classList.add('grayscale'); const ownedText = document.createElement('div'); ownedText.className = 'absolute inset-0 flex items-center justify-center text-white font-bold text-xl bg-black/50'; ownedText.textContent = 'å‡æ˜Ÿ'; card.appendChild(ownedText); const toast = document.createElement('div'); toast.className = 'absolute -top-2 right-0 text-cyan-400 font-bold fragment-toast'; toast.textContent = `+${char.fragmentsGained} ç¢ç‰‡`; card.appendChild(toast); }, 1000 + index * 80); }
            });

            const continuePrompt = document.createElement('div');
            continuePrompt.id = 'continue-prompt';
            continuePrompt.className = 'absolute bottom-4 left-1/2 -translate-x-1/2 text-white/80 font-bold animate-pulse';
            continuePrompt.textContent = 'é»æ“Šä»»æ„è™•ç¹¼çºŒ';
            container.appendChild(continuePrompt);

            function clearResults() {
                container.removeEventListener('click', clearResults);
                container.querySelectorAll('.card-on-canvas, #continue-prompt').forEach(el => el.remove());
                updateAllUI();
                toggleButtons(true);
                isDrawingAnimation = false;
            }
            container.addEventListener('click', clearResults);
        }

        function updateHallOfLegends() {
            const collectedURs = Object.values(characterCollection).filter(c => c.rarity === 'UR');
            const collectedUURs = Object.values(characterCollection).filter(c => c.rarity === 'UUR');
            if (collectedURs.length === 0 && collectedUURs.length === 0) { dom.hallOfLegendsContainer.classList.add('hidden'); return; }
            dom.hallOfLegendsContainer.classList.remove('hidden');
            dom.hallOfLegendsGrid.innerHTML = '';
            collectedUURs.forEach(data => { const card = document.createElement('div'); card.className = 'rarity-uur p-4 rounded-lg flex flex-col items-center justify-center text-center bg-gradient-to-br from-slate-900/50 via-purple-900/50 to-slate-900/50 col-span-1 sm:col-span-2 md:col-span-3'; card.innerHTML = `<p class="text-2xl font-bold text-rarity-uur">${data.name}</p><p class="text-lg text-yellow-300/80 mt-1">${data.title}</p>`; dom.hallOfLegendsGrid.appendChild(card); });
            collectedURs.forEach(data => { const card = document.createElement('div'); card.className = 'rarity-ur p-4 rounded-lg flex flex-col items-center justify-center text-center bg-gradient-to-br from-purple-900/50 to-slate-900/50'; card.innerHTML = `<p class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-violet-300 to-white">${data.name}</p><p class="text-sm text-yellow-300/80 mt-1">${data.title}</p>`; dom.hallOfLegendsGrid.appendChild(card); });
        }
        function updateCounters() {
            dom.canvasSrPity.textContent = pityCounters.sr;
            dom.canvasSsrPity.textContent = pityCounters.ssr;
            dom.canvasSsrPityMax.textContent = `/${PITY_CONFIG.SSR}`;
            dom.canvasTotalPulls.textContent = totalPulls;
            dom.canvasNStat.textContent = rarityCounts.N; dom.canvasRStat.textContent = rarityCounts.R; dom.canvasSrStat.textContent = rarityCounts.SR; dom.canvasSsrStat.textContent = rarityCounts.SSR; dom.canvasUrStat.textContent = rarityCounts.UR; dom.canvasUurStat.textContent = rarityCounts.UUR;
            dom.stardustStonesCounter.textContent = stardustStones; dom.fragmentsCounter.textContent = fragments;
        }
        function toggleButtons(enabled) { dom.draw1Btn.disabled = !enabled || stardustStones < DRAW_COST.single; dom.draw10Btn.disabled = !enabled || stardustStones < DRAW_COST.multi; dom.drawFragmentBtn1.disabled = !enabled || fragments < DRAW_COST.fragmentSingle; dom.drawFragmentBtn3.disabled = !enabled || fragments < DRAW_COST.fragmentMulti; }
        function updateButtonCosts() {
            dom.draw1Btn.textContent = `å¬å–š x 1 (ğŸ’${DRAW_COST.single})`;
            dom.draw10Btn.textContent = `å¬å–š x 10 (ğŸ’${DRAW_COST.multi})`;
            dom.drawFragmentBtn1.textContent = `ç¢ç‰‡x1 (âœ¨${DRAW_COST.fragmentSingle})`;
            dom.drawFragmentBtn3.textContent = `ç¢ç‰‡x3 (âœ¨${DRAW_COST.fragmentMulti})`;
        }
        function updateAllUI() { updateCounters(); updateHallOfLegends(); toggleButtons(true); updateAchievementNotification(); updateButtonCosts(); }

        // --- Modal & Features ---
        function setDate() { const today = new Date(); dom.dateDisplay.textContent = `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`; }
        function activatePuddingMode() { dom.body.classList.add('pudding-mode'); isPuddingModeActive = true; }
        function generateStarRating(rating, max) { let stars = ''; for (let i = 0; i < max; i++) { stars += i < rating ? 'â˜…' : 'â˜†'; } return stars; }
        function calculateAndShowLuck() {
            const today = new Date().toDateString();
            const todayPulls = gachaHistory.filter(entry => new Date(entry.date).toDateString() === today).flatMap(entry => entry.results);
            const adj = CONSTELLATION_ADJECTIVES[Math.floor(Math.random() * CONSTELLATION_ADJECTIVES.length)];
            const noun = CONSTELLATION_NOUNS[Math.floor(Math.random() * CONSTELLATION_NOUNS.length)];
            const constellationName = `${adj}${noun}åº§`;
            if (todayPulls.length === 0) { dom.luckModalBody.innerHTML = `<p class="text-xl font-bold">ä»Šæ—¥ä½ çš„é‹å‹¢æ˜Ÿåº§æ˜¯ï¼š${constellationName}</p><p class="mt-4 text-slate-400">å°šæœªå¬å–šï¼Œç„¡æ³•çªºæ¢ä»Šæ—¥çš„å‘½é‹ã€‚å¿«ä¾†æç¹ªå±¬æ–¼ä½ çš„æ˜Ÿè¾°å§ï¼</p>`; dom.luckModal.classList.remove('hidden'); return; }
            let highestRarity = 'N';
            const rarityOrder = ['N', 'R', 'SR', 'SSR', 'UR', 'UUR'];
            const todayRarityCounts = { N: 0, R: 0, SR: 0, SSR: 0, UR: 0, UUR: 0 };
            todayPulls.forEach(pull => { todayRarityCounts[pull.rarity]++; if (rarityOrder.indexOf(pull.rarity) > rarityOrder.indexOf(highestRarity)) { highestRarity = pull.rarity; } });
            const luckLevels = { UUR: { title: 'å¤§å‰', color: 'text-rarity-uur', text: 'é›–ç„¶æ˜¯æœ€å¥½çš„é‹æ°£ï¼Œä½†åŒæ™‚ä¹Ÿè¢«èªç‚ºä¹‹å¾Œçš„é‹å‹¢æœƒå‘ˆä¸‹é™è¶¨å‹¢ã€‚ æ‰€ä»¥æœ‰å¹¸æŠ½åˆ°ã€Œå¤§å‰ã€çš„è©±ï¼Œè¦æ³¨æ„åŠªåŠ›ç¶­æŒç¾ç‹€å“Ÿã€‚' }, UR: { title: 'å‰', color: 'text-rarity-ur', text: 'åƒ…æ¬¡æ–¼ã€Œå¤§å‰ã€çš„ç¬¬äºŒå¥½çš„é‹å‹¢ã€‚ æ²’æœ‰å¤§å‰é‚£æ¨£çš„é‹å‹¢æ€¥åŠ‡ä¸‹é™çš„å¯èƒ½æ€§ï¼Œä¸€æ®µæ™‚é–“å…§å¯ä»¥æ”¾å¿ƒã€‚' }, SSR: { title: 'ä¸­å‰', color: 'text-rarity-ssr', text: 'é‹æ°£æ˜¯ã€Œå‰ã€çš„ä¸€åŠã€‚ æ ¹æ“šå€‹äººåŠªåŠ›ä»Šå¾Œå¯èƒ½é‹æ°£æœƒä¸Šå‡ã€‚' }, SR: { title: 'å°å‰', color: 'text-rarity-sr', text: 'ã€Œä¸­å‰ã€å’Œã€Œæœ«å‰ã€ä¹‹é–“çš„é‹å‹¢ï¼Œèªªä¸ä¸Šå¥½ä½†ä¹Ÿä¸ç®—å·®ã€‚ æ“šèªªåªæœƒæœ‰å°å°çš„å¹¸ç¦ï¼Œä½†ä¸å®œéåº¦è¿½æ±‚ã€‚' }, R: { title: 'æœ«å‰', color: 'text-rarity-r', text: 'æ’åœ¨ã€Œå‰ã€æœ€å¾Œçš„é‹å‹¢ï¼Œæ˜¯ã€Œå‰ã€ä¹‹ä¸­æœ€å·®çš„ã€‚ ä½†æ˜¯ä¹Ÿæ„å‘³è‘—æœ‰è¨±å¤šä¸Šå‡ç©ºé–“ï¼Œå¯ä»¥æœŸå¾…ä»Šå¾Œçš„è®ŠåŒ–ã€‚' }, N: { title: 'å‡¶', color: 'text-rarity-n', text: 'é‹å‹¢ä¸å¥½ï¼Œä½†æ˜¯ä¹Ÿä¸ä¸€å®šçµ•å°æœƒç™¼ç”Ÿå£äº‹ã€‚ éœ€è¦å°å¿ƒè¬¹æ…ã€‚ é‡æ–°å¯©è¦–è‡ªèº«ä¸¦åŠ ä»¥æ”¹æ­£ï¼Œé‹å‹¢æœƒä¸Šå‡ã€‚' } };
            const loveRating = {UUR: 5, UR: 4, SSR: 3, SR: 2, R: 1, N: 1}[highestRarity];
            const workScore = todayRarityCounts.SR * 1 + todayRarityCounts.SSR * 3 + todayRarityCounts.UR * 5 + todayRarityCounts.UUR * 10;
            let workRating = 1; if (workScore > 30) workRating = 5; else if (workScore > 15) workRating = 4; else if (workScore > 5) workRating = 3; else if (workScore > 0) workRating = 2;
            const moneyScore = todayRarityCounts.SSR * 2 + todayRarityCounts.UR * 5 + todayRarityCounts.UUR * 10;
            let moneyRating = 1; if (moneyScore > 50) moneyRating = 5; else if (moneyScore > 25) moneyRating = 4; else if (moneyScore > 10) moneyRating = 3; else if (moneyScore > 0) moneyRating = 2;
            const luck = luckLevels[highestRarity];
            dom.luckModalBody.innerHTML = `<p class="text-xl font-bold">ä»Šæ—¥ä½ çš„é‹å‹¢æ˜Ÿåº§æ˜¯ï¼š${constellationName}</p><p class="text-4xl font-bold ${luck.color} mt-4">${luck.title}</p><div class="text-left mt-4 space-y-1 text-yellow-300"><p>æˆ€æ„›é‹ï¼š${generateStarRating(loveRating, 5)}</p><p>äº‹æ¥­é‹ï¼š${generateStarRating(workRating, 5)}</p><p>é‡‘éŒ¢é‹ï¼š${generateStarRating(moneyRating, 5)}</p></div><p class="mt-4 text-slate-300 text-left">${luck.text}</p>`;
            dom.luckModal.classList.remove('hidden');
        }
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 bg-green-500 text-white font-bold py-2 px-5 rounded-lg shadow-lg toast-notification z-[100]';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 1900);
        }
        function populateInfoModal() {
            dom.infoModalBody.innerHTML = '';
            const mainPoolTitle = document.createElement('h4'); mainPoolTitle.className = 'text-lg font-bold text-yellow-300 border-b border-yellow-300/50 pb-1 mb-2'; mainPoolTitle.textContent = 'æ˜Ÿå¡µçŸ³å¬å–š'; dom.infoModalBody.appendChild(mainPoolTitle);
            ['UR', 'SSR', 'SR', 'R', 'N'].forEach(rarity => { const prob = PROBABILITIES[rarity]; const characters = CHARACTERS[rarity].characters; const section = document.createElement('div'); section.className = 'pb-2'; const names = (rarity === 'UR') ? characters.map(c => c.name).join('ã€') : characters.join('ã€'); section.innerHTML = `<h3 class="text-xl font-bold text-rarity-${rarity.toLowerCase()}">${rarity} (æ©Ÿç‡: ${(prob*100).toFixed(1)}%)</h3><p class="text-slate-300 text-sm mt-1 break-words">åŒ…å«è§’è‰²ï¼š${names}</p>`; dom.infoModalBody.appendChild(section); });
            const fragmentPoolTitle = document.createElement('h4'); fragmentPoolTitle.className = 'text-lg font-bold text-cyan-300 border-b border-cyan-300/50 pb-1 mb-2 mt-4'; fragmentPoolTitle.textContent = 'ç¢ç‰‡å¬å–š'; dom.infoModalBody.appendChild(fragmentPoolTitle);
            ['UUR', 'UR', 'SSR'].forEach(rarity => { const prob = PROBABILITIES_FRAGMENT[rarity]; const characters = CHARACTERS[rarity].characters; const section = document.createElement('div'); section.className = 'pb-2'; const isUURCollected = characterCollection[CHARACTERS.UUR.characters[0].id]; const names = (rarity === 'UUR' && !isUURCollected) ? '???' : ((rarity === 'UUR' || rarity === 'UR') ? characters.map(c => c.name).join('ã€') : characters.join('ã€')); section.innerHTML = `<h3 class="text-xl font-bold text-rarity-${rarity.toLowerCase()}">${rarity} (æ©Ÿç‡: ${(prob*100).toFixed(1).replace('.0','')}%)</h3><p class="text-slate-300 text-sm mt-1 break-words">åŒ…å«è§’è‰²ï¼š${names}</p>`; dom.infoModalBody.appendChild(section); });
        }
        function populateHistoryModal() { dom.historyModalBody.innerHTML = ''; if (gachaHistory.length === 0) { dom.historyModalBody.innerHTML = '<p class="text-center text-slate-400">å°šç„¡å¬å–šç´€éŒ„</p>'; return; } gachaHistory.forEach(entry => { const entryDiv = document.createElement('div'); entryDiv.className = 'p-2 bg-slate-700/50 rounded'; const time = new Date(entry.date).toLocaleString(); const summary = entry.results.map(r => `<span class="font-bold text-rarity-${r.rarity.toLowerCase()}">${r.rarity}</span>`).join(' '); entryDiv.innerHTML = `<p class="text-xs text-slate-400 mb-1">${time}</p><div class="flex flex-wrap gap-2">${summary}</div>`; dom.historyModalBody.appendChild(entryDiv); }); }
        function populateCollectionModal() {
            dom.collectionModalBody.innerHTML = '';
            ['UUR', 'UR', 'SSR', 'SR', 'R', 'N'].forEach(rarity => {
                const rarityData = CHARACTERS[rarity];
                const characters = rarityData.characters; 
                const maxStars = rarityData.maxStars;
                if (!characters || characters.length === 0) return;
                const section = document.createElement('div'); section.className = 'pb-2 border-b border-slate-700 last:border-b-0';
                const title = document.createElement('h3'); title.className = `text-xl font-bold text-rarity-${rarity.toLowerCase()}`; title.textContent = `${rarity} (ä¸Šé™ ${maxStars}â˜…)`; section.appendChild(title);
                const grid = document.createElement('div'); grid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mt-2';
                characters.forEach(char => {
                    const charData = (typeof char === 'object') ? char : { name: char }; const charIdentifier = charData.id || charData.name;
                    const collectedData = characterCollection[charIdentifier];
                    const card = document.createElement('div'); card.className = `p-2 rounded-lg text-center transition-all duration-300 ${collectedData ? `rarity-${rarity.toLowerCase()} bg-slate-900/70` : 'bg-slate-700/50'}`;
                    if (collectedData) {
                        const stars = collectedData.stars;
                        if (stars === maxStars) card.classList.add('star-max-glow');
                        const starDisplay = `<div class="star-rating text-lg">${'â˜…'.repeat(stars)}${'â˜†'.repeat(maxStars - stars)}</div>`;
                        card.innerHTML = `<p class="font-bold">${charData.name}</p>${charData.title ? `<p class="text-xs text-yellow-300/80">${charData.title}</p>` : ''}${starDisplay}`;
                    } else { card.innerHTML = `<p class="font-bold text-slate-400">???</p>`; card.classList.add('grayscale'); }
                    grid.appendChild(card);
                });
                section.appendChild(grid); dom.collectionModalBody.appendChild(section);
            });
        }

        // --- æˆå°±ç³»çµ± ---
        function checkAchievements() {
            Object.keys(achievements).forEach(key => {
                const ach = achievements[key];
                if (ach.status === 'locked' && ach.condition()) {
                    ach.status = 'unlocked';
                }
            });
            updateAchievementNotification();
        }
        function claimAchievement(key) {
            const ach = achievements[key];
            if (ach && ach.status === 'unlocked') {
                stardustStones += ach.reward.stones || 0;
                fragments += ach.reward.fragments || 0;
                ach.status = 'claimed';
                updateAllUI();
                populateAchievementModal();
                saveData();
            }
        }
        function claimAllAchievements() {
            let stonesGained = 0;
            let fragmentsGained = 0;
            let claimedCount = 0;
            Object.keys(achievements).forEach(key => {
                const ach = achievements[key];
                if (ach.status === 'unlocked') {
                    stonesGained += ach.reward.stones || 0;
                    fragmentsGained += ach.reward.fragments || 0;
                    ach.status = 'claimed';
                    claimedCount++;
                }
            });

            if (claimedCount > 0) {
                stardustStones += stonesGained;
                fragments += fragmentsGained;
                updateAllUI();
                populateAchievementModal();
                saveData();
            }
        }
        function updateAchievementNotification() {
            const hasUnlockable = Object.values(achievements).some(ach => ach.status === 'unlocked');
            dom.achievementRedDot.classList.toggle('hidden', !hasUnlockable);
        }
        function populateAchievementModal() {
            dom.achievementModalBody.innerHTML = '';
            dom.achievementModalBody.classList.add('flex', 'flex-col');
            const hasUnlockable = Object.values(achievements).some(ach => ach.status === 'unlocked');
            dom.claimAllAchievementsBtn.disabled = !hasUnlockable;

            const achievementCategories = {
                'æ–°æ‰‹å•Ÿç¨‹': ['firstDraw', 'firstMultiDraw', 'firstFragmentPull', 'knowTheOdds', 'aNewBeginning', 'diligentCollector', 'historian', 'theArchivist', 'quickDraw'],
                'æ”¶è—ä¹‹è·¯': ['nCollector', 'rMaster', 'srMaster', 'ssrMaster', 'urMaster', 'galleryExpert', 'rainbowCollection', 'godAndDemon', 'knightsVow', 'magicMystery', 'collectorSorrow'],
                'æ˜Ÿç´šå¤§å¸«': ['twoStar', 'fourStar', 'first5Star', 'srPerfection', 'fiveStarSSR', 'starForged', 'fiveStarTeam', 'threeStarTeam', 'overflowingStarlight', 'balancedDevelopment', 'flameDragonMaster', 'rElite', 'srElite', 'earlyMaxOut'],
                'å¹¸é‹æ™‚åˆ»': ['firstSSR', 'firstUR', 'allN', 'allR', 'doubleSSR', 'tripleSSR', 'perfectTen', 'singlePullLuck', 'archdukeOfEurope', 'midasTouch', 'perfectConstellation', 'pityEnjoyer', 'abyssStaresBack', 'rockBottomLuck'],
                'ç‰¹æ®ŠæŒ‘æˆ°': ['total100', 'total500', 'fragmentHoarder', 'fortuneTeller', 'stardustHoarder', 'fragmentSummoner', 'theGambler', 'dailyPersistence', 'thePatient', 'constellationMaster', 'starryNight', 'bigSpender', 'puddingEnjoyer', 'penniless', 'fragmentBanker', 'pacifist', 'allOrNothing', 'theStrategist', 'starCollector']
            };

            const tabNav = document.createElement('div');
            tabNav.id = 'achievement-tabs';
            tabNav.className = 'flex border-b border-slate-700 mb-4 overflow-x-auto flex-shrink-0';
            const contentContainer = document.createElement('div');
            contentContainer.className = 'overflow-y-auto flex-grow';

            Object.keys(achievementCategories).forEach((category, index) => {
                const tabButton = document.createElement('button');
                const panelId = `ach-panel-${category.replace(/\s/g, '-')}`;
                tabButton.className = `ach-tab-btn flex-shrink-0 py-2 px-4 font-semibold whitespace-nowrap transition-colors duration-200 ${index === 0 ? 'text-cyan-300 border-b-2 border-cyan-300' : 'text-slate-400 border-b-2 border-transparent hover:text-white'}`;
                tabButton.textContent = category;
                tabButton.dataset.target = panelId;
                tabNav.appendChild(tabButton);

                const contentPanel = document.createElement('div');
                contentPanel.id = panelId;
                contentPanel.className = `ach-content-panel space-y-3 pr-2 ${index !== 0 ? 'hidden' : ''}`;
                
                const categoryAchievements = achievementCategories[category];
                if (categoryAchievements) {
                    categoryAchievements.forEach(key => {
                        const ach = achievements[key];
                        if (!ach) return;
                        if (key === 'puddingTruth' && ach.status === 'locked') return;
                        
                        const achDiv = document.createElement('div');
                        achDiv.className = `flex items-center justify-between p-3 rounded-lg ${ach.status !== 'locked' ? 'bg-slate-700' : 'bg-slate-900/50'}`;
                        let rewardText = '';
                        if (ach.reward.stones > 0) rewardText += `ğŸ’ ${ach.reward.stones} `;
                        if (ach.reward.fragments > 0) rewardText += `âœ¨ ${ach.reward.fragments}`;
                        achDiv.innerHTML = `<div><h4 class="font-bold text-lg ${ach.status !== 'locked' ? 'text-yellow-300' : 'text-slate-300'}">${ach.name}</h4><p class="text-sm text-slate-400">${ach.description}</p><p class="text-sm font-bold text-cyan-300 mt-1">çå‹µ: ${rewardText}</p></div>`;
                        const button = document.createElement('button');
                        button.className = 'font-bold py-2 px-5 rounded-lg transition-colors flex-shrink-0 ml-4';
                        if (ach.status === 'unlocked') {
                            button.textContent = 'é ˜å–';
                            button.className += ' bg-yellow-500 hover:bg-yellow-400 text-slate-900';
                            button.onclick = () => claimAchievement(key);
                        } else if (ach.status === 'claimed') {
                            button.textContent = 'å·²é ˜å–';
                            button.className += ' bg-gray-600 cursor-not-allowed';
                            button.disabled = true;
                        } else {
                            button.textContent = 'æœªé”æˆ';
                            button.className += ' bg-gray-800 text-gray-500 cursor-not-allowed';
                            button.disabled = true;
                        }
                        achDiv.appendChild(button);
                        contentPanel.appendChild(achDiv);
                    });
                }
                contentContainer.appendChild(contentPanel);
            });

            dom.achievementModalBody.appendChild(tabNav);
            dom.achievementModalBody.appendChild(contentContainer);
        }
        
        // --- äº‹ä»¶ç›£è½ ---
        function setupEventListeners() {
            dom.draw1Btn.addEventListener('click', () => processDraw(1, 'main'));
            dom.draw10Btn.addEventListener('click', () => processDraw(10, 'main'));
            dom.drawFragmentBtn1.addEventListener('click', () => processDraw(1, 'fragment'));
            dom.drawFragmentBtn3.addEventListener('click', () => processDraw(3, 'fragment'));
            dom.claimDailyBtn.addEventListener('click', () => { stardustStones += DAILY_REWARD; dailyClaims++; dom.claimDailyBtn.disabled = true; dom.claimDailyBtn.textContent = 'å·²é ˜å–'; checkAchievements(); updateAllUI(); saveData(); });
            dom.resetBtn.addEventListener('click', () => { 
                if (localStorage.getItem('hasResetOnce') !== 'true') {
                    const ach = achievements['aNewBeginning'];
                    if (ach.status === 'locked') {
                       stardustStones += ach.reward.stones;
                       fragments += ach.reward.fragments;
                       ach.status = 'claimed';
                       showToast('é”æˆæˆå°±ï¼šå¶„æ–°é–‹ç«¯ï¼');
                       localStorage.setItem('hasResetOnce', 'true');
                       saveData();
                    }
                }
                dom.resetModal.classList.remove('hidden'); 
            });
            dom.confirmResetBtn.addEventListener('click', () => { dom.resetModal.classList.add('hidden'); resetGame(); });
            dom.cancelResetBtn.addEventListener('click', () => dom.resetModal.classList.add('hidden'));
            dom.claimAllAchievementsBtn.addEventListener('click', claimAllAchievements);
            dom.rapidTapLeftBtn.addEventListener('click', () => handleRapidClick('left'));
            dom.rapidTapRightBtn.addEventListener('click', () => handleRapidClick('right'));
            
            const startDrawing = (x, y) => { if (isDrawingAnimation) return; isDrawing = true; constellationPoints = [{ x, y }]; dom.canvasOverlay.style.display = 'none'; };
            const draw = (x, y) => { if (!isDrawing || isDrawingAnimation) return; constellationPoints.push({ x, y }); drawStars(); drawConstellation(); };
            const stopDrawing = () => { isDrawing = false; };
            dom.canvas.addEventListener('mousedown', (e) => startDrawing(e.offsetX, e.offsetY));
            dom.canvas.addEventListener('mousemove', (e) => draw(e.offsetX, e.offsetY));
            dom.canvas.addEventListener('mouseup', stopDrawing); dom.canvas.addEventListener('mouseleave', stopDrawing);
            dom.canvas.addEventListener('touchstart', (e) => { e.preventDefault(); const r = dom.canvas.getBoundingClientRect(); startDrawing(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); }, { passive: false });
            dom.canvas.addEventListener('touchmove', (e) => { e.preventDefault(); const r = dom.canvas.getBoundingClientRect(); draw(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); }, { passive: false });
            dom.canvas.addEventListener('touchend', stopDrawing); dom.canvas.addEventListener('touchcancel', stopDrawing);

            window.addEventListener('resize', () => { resizeCanvas(); generateStars(100); drawStars(); });
            
            dom.infoBtn.addEventListener('click', () => { populateInfoModal(); dom.infoModal.classList.remove('hidden'); infoViews++; checkAchievements(); saveData(); });
            dom.closeInfoModalBtn.addEventListener('click', () => dom.infoModal.classList.add('hidden'));
            dom.historyBtn.addEventListener('click', () => { populateHistoryModal(); dom.historyModal.classList.remove('hidden'); historyViews++; checkAchievements(); saveData(); });
            dom.closeHistoryModalBtn.addEventListener('click', () => dom.historyModal.classList.add('hidden'));
            dom.collectionBtn.addEventListener('click', () => { populateCollectionModal(); dom.collectionModal.classList.remove('hidden'); });
            dom.closeCollectionModalBtn.addEventListener('click', () => dom.collectionModal.classList.add('hidden'));
            dom.luckBtn.addEventListener('click', () => { calculateAndShowLuck(); luckCalculations++; checkAchievements(); saveData(); });
            dom.closeLuckModalBtn.addEventListener('click', () => dom.luckModal.classList.add('hidden'));
            dom.achievementBtn.addEventListener('click', () => { populateAchievementModal(); dom.achievementModal.classList.remove('hidden'); });
            dom.closeAchievementModalBtn.addEventListener('click', () => dom.achievementModal.classList.add('hidden'));
            dom.skipAnimationBtn.addEventListener('click', () => { if (animationFrameId) { skipAnimationUses++; checkAchievements(); saveData(); cancelAnimationFrame(animationFrameId); animationFrameId = null; endAnimation(); } });
            dom.claimFragmentBtn.addEventListener('click', () => { fragments += 50; fragmentClaims++; updateAllUI(); startFragmentTimer(); checkAchievements(); saveData(); });
        
            dom.achievementModal.addEventListener('click', (e) => {
                const button = e.target.closest('.ach-tab-btn');
                if (button) {
                    dom.achievementModal.querySelectorAll('.ach-tab-btn').forEach(btn => {
                        btn.classList.remove('text-cyan-300', 'border-cyan-300');
                        btn.classList.add('text-slate-400', 'border-transparent');
                    });
                    dom.achievementModal.querySelectorAll('.ach-content-panel').forEach(panel => {
                        panel.classList.add('hidden');
                    });
                    
                    button.classList.add('text-cyan-300', 'border-cyan-300');
                    button.classList.remove('text-slate-400', 'border-transparent');
                    const targetPanel = document.getElementById(button.dataset.target);
                    if (targetPanel) {
                        targetPanel.classList.remove('hidden');
                    }
                }
            });
        }

        function startFragmentTimer() {
            dom.claimFragmentBtn.disabled = true;
            fragmentClaimTimer = 30;
            dom.claimFragmentBtn.textContent = `é ˜å–ç¢ç‰‡ (${fragmentClaimTimer}s)`;
            if (fragmentClaimIntervalId) clearInterval(fragmentClaimIntervalId);
            fragmentClaimIntervalId = setInterval(() => {
                fragmentClaimTimer--;
                dom.claimFragmentBtn.textContent = `é ˜å–ç¢ç‰‡ (${fragmentClaimTimer}s)`;
                if (fragmentClaimTimer <= 0) {
                    clearInterval(fragmentClaimIntervalId);
                    dom.claimFragmentBtn.disabled = false;
                    dom.claimFragmentBtn.textContent = 'é ˜å– 50 ç¢ç‰‡';
                }
            }, 1000);
        }

        function handleRapidClick(side) {
            if (isRapidClickOnCooldown) return;
            if (side === lastTapArea) {
                clearTimeout(rapidClickTimerId);
                rapidClickCount = 0;
                lastTapArea = null;
                dom.rapidClickText.textContent = `è«‹äº¤æ›¿é»æ“Šï¼`;
                setTimeout(() => {
                    if (!isRapidClickOnCooldown) dom.rapidClickText.textContent = `æ˜Ÿè¾°çˆ†ç™¼ (0/10)`;
                }, 1000);
                return;
            }

            lastTapArea = side;
            
            if (rapidClickCount === 0) {
                rapidClickTimerId = setTimeout(() => {
                    rapidClickCount = 0;
                    lastTapArea = null;
                    dom.rapidClickText.textContent = 'æ˜Ÿè¾°çˆ†ç™¼ (0/10)';
                }, 2000);
            }

            rapidClickCount++;
            dom.rapidClickText.textContent = `æ˜Ÿè¾°çˆ†ç™¼ (${rapidClickCount}/10)`;

            if (rapidClickCount >= 10) {
                clearTimeout(rapidClickTimerId);
                stardustStones += 1000;
                showToast('å–å¾— 1000 æ˜Ÿå¡µçŸ³');
                rapidClickCount = 0;
                lastTapArea = null;
                startRapidClickCooldown();
                updateAllUI();
                saveData();
            }
        }

        function startRapidClickCooldown() {
            isRapidClickOnCooldown = true;
            dom.rapidClickContainer.classList.add('opacity-50', 'cursor-not-allowed');
            rapidClickCooldownTimer = 60; 

            const intervalId = setInterval(() => {
                rapidClickCooldownTimer--;
                dom.rapidClickText.textContent = `å†·å»ä¸­ (${rapidClickCooldownTimer}s)`;
                if (rapidClickCooldownTimer <= 0) {
                    clearInterval(intervalId);
                    isRapidClickOnCooldown = false;
                    dom.rapidClickContainer.classList.remove('opacity-50', 'cursor-not-allowed');
                    dom.rapidClickText.textContent = 'æ˜Ÿè¾°çˆ†ç™¼ (0/10)';
                }
            }, 1000);
        }

        // --- è³‡æ–™å­˜æª”èˆ‡é‡ç½® ---
        function getInitialAchievements() {
            return {
                'firstDraw': { name: 'åˆè©¦å•¼è²', description: 'é€²è¡Œé¦–æ¬¡å¬å–š', reward: { stones: 40, fragments: 0 }, status: 'locked', condition: () => totalPulls >= 1 },
                'firstMultiDraw': { name: 'æ˜Ÿç¾¤çš„å…±é³´', description: 'é€²è¡Œé¦–æ¬¡10é€£å¬å–š', reward: { stones: 120, fragments: 0 }, status: 'locked', condition: () => gachaHistory.some(h => h.results.length >= 10) },
                'firstFragmentPull': { name: 'é¦–æ¬¡ç¢ç‰‡å¬å–š', description: 'é€²è¡Œé¦–æ¬¡ç¢ç‰‡å¬å–š', reward: { stones: 50, fragments: 20 }, status: 'locked', condition: () => fragmentSummons > 0 },
                'knowTheOdds': { name: 'çŸ¥å·±çŸ¥å½¼', description: 'é¦–æ¬¡æ‰“é–‹å¬å–šè©³æƒ…é¢æ¿', reward: { stones: 30, fragments: 0 }, status: 'locked', condition: () => infoViews > 0 },
                'aNewBeginning': { name: 'å¶„æ–°é–‹ç«¯', description: 'é¦–æ¬¡é‡ç½®éŠæˆ²é€²åº¦', reward: { stones: 1000, fragments: 0 }, status: 'locked', condition: () => false }, // Handled manually
                'nCollector': { name: 'åº•å±¤æ”¶è—å®¶', description: 'é›†é½Šæ‰€æœ‰Nç´šè§’è‰²', reward: { stones: 50, fragments: 10 }, status: 'locked', condition: () => CHARACTERS.N.characters.every(name => characterCollection[name]) },
                'rMaster': { name: 'Rç´šå¤§å¸«', description: 'é›†é½Šæ‰€æœ‰Rç´šè§’è‰²', reward: { stones: 80, fragments: 15 }, status: 'locked', condition: () => CHARACTERS.R.characters.every(name => characterCollection[name]) },
                'srMaster': { name: 'SRæ”¶è—å®¶', description: 'é›†é½Šæ‰€æœ‰SRç´šè§’è‰²', reward: { stones: 160, fragments: 30 }, status: 'locked', condition: () => CHARACTERS.SR.characters.every(name => characterCollection[name]) },
                'ssrMaster': { name: 'SSRé‘„é€ å¸«', description: 'é›†é½Šæ‰€æœ‰SSRç´šè§’è‰²', reward: { stones: 320, fragments: 60 }, status: 'locked', condition: () => CHARACTERS.SSR.characters.every(name => characterCollection[name]) },
                'urMaster': { name: 'URæ½›æ„è­˜', description: 'é›†é½Šæ‰€æœ‰URç´šè§’è‰²', reward: { stones: 800, fragments: 160 }, status: 'locked', condition: () => CHARACTERS.UR.characters.every(char => characterCollection[char.id]) },
                'galleryExpert': { name: 'åœ–é‘‘å°ˆå®¶', description: 'è§£é–åœ–é‘‘ä¸­75%çš„è§’è‰²', reward: { stones: 400, fragments: 100 }, status: 'locked', condition: () => (Object.keys(characterCollection).length / TOTAL_CHARACTER_COUNT) >= 0.75 },
                'rainbowCollection': { name: 'å½©è™¹æ”¶è—', description: 'N, R, SR, SSR, URç¨€æœ‰åº¦çš„è§’è‰²è‡³å°‘å„æ“æœ‰ä¸€å', reward: { stones: 300, fragments: 100 }, status: 'locked', condition: () => ['N', 'R', 'SR', 'SSR', 'UR'].every(r => rarityCounts[r] > 0) },
                'godAndDemon': { name: 'ç¥é­”ä¹‹å·”', description: 'åŒæ™‚æ“æœ‰å‰µä¸–ä¹‹ç¥èˆ‡æ»…ä¸–é­”é¾', reward: { stones: 200, fragments: 50 }, status: 'locked', condition: () => characterCollection[1] && characterCollection[2] },
                'knightsVow': { name: 'é¨å£«çš„èª“è¨€', description: 'é›†é½Šæ‰€æœ‰ã€Œé¨å£«ã€é¡å‹çš„è§’è‰²', reward: { stones: 100, fragments: 20 }, status: 'locked', condition: () => ['è¦‹ç¿’é¨å£«', 'çš‡å®¶é¨å£«åœ˜é•·', 'ç‚é¾é¨å£«', 'è–æ®¿é¨å£«'].every(name => characterCollection[name]) },
                'magicMystery': { name: 'é­”æ³•çš„å¥§ç§˜', description: 'é›†é½Šæ‰€æœ‰ã€Œæ³•å¸«ã€é¡å‹çš„è§’è‰²', reward: { stones: 100, fragments: 20 }, status: 'locked', condition: () => ['é­”æ³•å­¸å¾’', 'å¤§é­”å°å¸«', 'æ™‚ç©ºå¤§æ³•å¸«', 'å…ƒç´ ä½¿'].every(name => characterCollection[name]) },
                'collectorSorrow': { name: 'æ”¶è—å®¶ä¹‹æ‚²', description: 'é›†é½Šæ‰€æœ‰Nå’ŒRå¡ï¼Œä½†å°šæœªæ“æœ‰UR', reward: { stones: 100, fragments: 50 }, status: 'locked', condition: () => CHARACTERS.N.characters.every(name => characterCollection[name]) && CHARACTERS.R.characters.every(name => characterCollection[name]) && rarityCounts.UR === 0 },
                'twoStar': { name: 'æ˜Ÿå…‰ä¹ç¾', description: 'é¦–æ¬¡å°‡ä»»æ„è§’è‰²å‡è‡³2æ˜Ÿ', reward: { stones: 50, fragments: 10 }, status: 'locked', condition: () => Object.values(characterCollection).some(c => c.stars >= 2) },
                'fourStar': { name: 'æ˜Ÿè¾°ä¹‹åŠ›', description: 'é¦–æ¬¡å°‡ä»»æ„è§’è‰²å‡è‡³4æ˜Ÿ', reward: { stones: 200, fragments: 50 }, status: 'locked', condition: () => Object.values(characterCollection).some(c => c.stars >= 4) },
                'first5Star': { name: 'ç™»å³°é€ æ¥µ', description: 'é¦–æ¬¡å°‡ä»»æ„è§’è‰²å‡è‡³5æ˜Ÿ', reward: { stones: 400, fragments: 80 }, status: 'locked', condition: () => Object.values(characterCollection).some(c => c.stars >= 5) },
                'srPerfection': { name: 'SRçš„æ¥µè‡´', description: 'æ“æœ‰ä¸€åæ»¿æ˜Ÿ(4æ˜Ÿ)çš„SRè§’è‰²', reward: { stones: 300, fragments: 60 }, status: 'locked', condition: () => Object.values(characterCollection).some(c => c.rarity === 'SR' && c.stars >= CHARACTERS.SR.maxStars) },
                'fiveStarSSR': { name: 'å‚³èªªçš„å·”å³°', description: 'æ“æœ‰ä¸€åæ»¿æ˜Ÿ(5æ˜Ÿ)çš„SSRè§’è‰²', reward: { stones: 600, fragments: 120 }, status: 'locked', condition: () => Object.values(characterCollection).some(c => c.rarity === 'SSR' && c.stars >= CHARACTERS.SSR.maxStars) },
                'starForged': { name: 'æ˜Ÿè¾°é‘„é€ è€…', description: 'æ“æœ‰3åæˆ–ä»¥ä¸Šæ»¿æ˜Ÿè§’è‰²', reward: { stones: 600, fragments: 120 }, status: 'locked', condition: () => Object.values(characterCollection).filter(c => c.stars >= CHARACTERS[c.rarity].maxStars).length >= 3 },
                'fiveStarTeam': { name: 'äº”æ˜Ÿæˆ°éšŠ', description: 'æ“æœ‰5åæˆ–ä»¥ä¸Šæ»¿æ˜Ÿè§’è‰²', reward: { stones: 800, fragments: 150 }, status: 'locked', condition: () => Object.values(characterCollection).filter(c => c.stars >= CHARACTERS[c.rarity].maxStars).length >= 5 },
                'threeStarTeam': { name: 'ä¸‰æ˜Ÿæˆ°éšŠ', description: 'æ“æœ‰5åæˆ–ä»¥ä¸Šä¸‰æ˜Ÿè§’è‰²', reward: { stones: 150, fragments: 30 }, status: 'locked', condition: () => Object.values(characterCollection).filter(c => c.stars >= 3).length >= 5 },
                'overflowingStarlight': { name: 'æ˜Ÿå…‰æ»¿æº¢', description: 'æ‰€æœ‰è§’è‰²ç¸½æ˜Ÿæ•¸é”åˆ°50', reward: { stones: 250, fragments: 50 }, status: 'locked', condition: () => Object.values(characterCollection).reduce((sum, char) => sum + char.stars, 0) >= 50 },
                'balancedDevelopment': { name: 'å‡è¡¡ç™¼å±•', description: 'N, R, SR, SSRç¨€æœ‰åº¦éƒ½è‡³å°‘æ“æœ‰ä¸€åäºŒæ˜Ÿè§’', reward: { stones: 150, fragments: 50 }, status: 'locked', condition: () => ['N', 'R', 'SR', 'SSR'].every(r => Object.values(characterCollection).some(c => c.rarity === r && c.stars >= 2)) },
                'flameDragonMaster': { name: 'ç‚é¾å¤§å¸«', description: 'å°‡ã€Œç‚é¾é¨å£«ã€å‡è‡³æ»¿æ˜Ÿ', reward: { stones: 200, fragments: 100 }, status: 'locked', condition: () => characterCollection['ç‚é¾é¨å£«'] && characterCollection['ç‚é¾é¨å£«'].stars >= CHARACTERS.SSR.maxStars },
                'rElite': { name: 'Rç´šç²¾è‹±', description: 'å°‡æ‰€æœ‰Rç´šè§’è‰²å‡è‡³2æ˜Ÿ', reward: { stones: 150, fragments: 80 }, status: 'locked', condition: () => CHARACTERS.R.characters.every(name => characterCollection[name] && characterCollection[name].stars >= 2) },
                'srElite': { name: 'SRç´šç²¾è‹±', description: 'å°‡æ‰€æœ‰SRç´šè§’è‰²å‡è‡³2æ˜Ÿ', reward: { stones: 200, fragments: 100 }, status: 'locked', condition: () => CHARACTERS.SR.characters.every(name => characterCollection[name] && characterCollection[name].stars >= 2) },
                'earlyMaxOut': { name: 'æ—©æœŸå„ªå‹¢', description: '100æŠ½å…§å°±æ“æœ‰ä¸€åæ»¿æ˜Ÿè§’è‰²', reward: { stones: 250, fragments: 50 }, status: 'locked', condition: () => totalPulls <= 100 && Object.values(characterCollection).some(c => c.stars >= CHARACTERS[c.rarity].maxStars) },
                'firstSSR': { name: 'è¶…å‡¡çš„ç‰‡é±—', description: 'é¦–æ¬¡å¬å–šåˆ°SSRè§’è‰²', reward: { stones: 200, fragments: 20 }, status: 'locked', condition: () => rarityCounts.SSR > 0 },
                'firstUR': { name: 'ç¥è©±çš„é–‹ç«¯', description: 'é¦–æ¬¡å¬å–šåˆ°URè§’è‰²', reward: { stones: 400, fragments: 40 }, status: 'locked', condition: () => rarityCounts.UR > 0 },
                'allN': { name: 'NNNNN?', description: 'åœ¨10é€£å¬å–šä¸­5å¼µä»¥ä¸Šç‚ºNå¡', reward: { stones: 120, fragments: 40 }, status: 'locked', condition: () => gachaHistory.some(h => h.results.length >= 10 && h.results.filter(r => r.rarity === 'N').length >= 5) },
                'allR': { name: 'RRRRR!', description: 'åœ¨10é€£å¬å–šä¸­5å¼µä»¥ä¸Šç‚ºRå¡', reward: { stones: 120, fragments: 40 }, status: 'locked', condition: () => gachaHistory.some(h => h.results.length >= 10 && h.results.filter(r => r.rarity === 'R').length >= 5) },
                'doubleSSR': { name: 'é›™å€çš„å–œæ‚…', description: 'åœ¨ä¸€æ¬¡10é€£å¬å–šä¸­ç²å¾—2åæˆ–ä»¥ä¸ŠSSR/URè§’è‰²', reward: { stones: 250, fragments: 40 }, status: 'locked', condition: () => gachaHistory.some(h => h.results.length >= 10 && h.results.filter(r => ['SSR', 'UR', 'UUR'].includes(r.rarity)).length >= 2) },
                'tripleSSR': { name: 'ä¸‰å€çš„å–œæ‚…', description: 'åœ¨ä¸€æ¬¡10é€£å¬å–šä¸­ç²å¾—3åæˆ–ä»¥ä¸ŠSSR/URè§’è‰²', reward: { stones: 500, fragments: 100 }, status: 'locked', condition: () => gachaHistory.some(h => h.results.length >= 10 && h.results.filter(r => ['SSR', 'UR', 'UUR'].includes(r.rarity)).length >= 3) },
                'perfectTen': { name: 'å®Œç¾çš„åé€£', description: 'åé€£å¬å–šä¸­æ²’æœ‰Nå¡', reward: { stones: 150, fragments: 30 }, status: 'locked', condition: () => gachaHistory.some(h => h.results.length >= 10 && !h.results.some(r => r.rarity === 'N')) },
                'singlePullLuck': { name: 'ä¸€ç™¼å…¥é­‚', description: 'åœ¨ã€Œå¬å–šx1ã€ä¸­ç›´æ¥ç²å¾—SSRæˆ–URè§’è‰²', reward: { stones: 100, fragments: 20 }, status: 'locked', condition: () => gachaHistory.some(h => h.results.length === 1 && (h.results[0].rarity === 'SSR' || h.results[0].rarity === 'UR')) },
                'archdukeOfEurope': { name: 'æ­æ´²å¤§å…¬', description: 'åœ¨ä¸€æ¬¡10é€£å¬å–šä¸­ç²å¾—2åæˆ–ä»¥ä¸ŠURè§’è‰²', reward: { stones: 1000, fragments: 200 }, status: 'locked', condition: () => gachaHistory.some(h => h.results.length >= 10 && h.results.filter(r => r.rarity === 'UR').length >= 2) },
                'midasTouch': { name: 'é»çŸ³æˆé‡‘', description: 'é€éç¢ç‰‡å¬å–šç²å¾—URæˆ–UURè§’è‰²', reward: { stones: 300, fragments: 100 }, status: 'locked', condition: () => gachaHistory.some(h => h.isFragmentPool && h.results.some(r => r.rarity === 'UR' || r.rarity === 'UUR')) },
                'perfectConstellation': { name: 'å®Œç¾æ˜Ÿåº§', description: 'ç¹ªè£½ä¸€å€‹å‰›å¥½7å€‹ç¯€é»çš„æ˜Ÿåº§ä¸¦å¬å–š', reward: { stones: 77, fragments: 7 }, status: 'locked', condition: () => gachaHistory.some(h => h.constellationPoints === 7) },
                'total100': { name: 'ç™¾æ¬¡è§€æ˜Ÿ', description: 'ç´¯è¨ˆå¬å–š100æ¬¡', reward: { stones: 240, fragments: 40 }, status: 'locked', condition: () => totalPulls >= 100 },
                'total500': { name: 'äº”ç™¾æ¬¡å‡æœ›', description: 'ç´¯è¨ˆå¬å–š500æ¬¡', reward: { stones: 500, fragments: 100 }, status: 'locked', condition: () => totalPulls >= 500 },
                'fragmentHoarder': { name: 'ç¢ç‰‡å¯Œç¿', description: 'ç´¯è¨ˆæ“æœ‰è¶…é1000ç¢ç‰‡', reward: { stones: 150, fragments: 80 }, status: 'locked', condition: () => fragments >= 1000 },
                'pityEnjoyer': { name: 'ä¿åº•çš„æº«æš–', description: 'é¦–æ¬¡è§¸ç™¼SSRä¿åº•æ©Ÿåˆ¶', reward: { stones: 50, fragments: 0 }, status: 'locked', condition: () => ssrPityTriggered },
                'fortuneTeller': { name: 'é‹å‹¢å åœå¸«', description: 'ç´¯è¨ˆä½¿ç”¨ã€Œçµç®—æœ¬æ—¥é‹å‹¢ã€åŠŸèƒ½5æ¬¡', reward: { stones: 50, fragments: 10 }, status: 'locked', condition: () => luckCalculations >= 5 },
                'diligentCollector': { name: 'å‹¤èƒ½è£œæ‹™', description: 'ç´¯è¨ˆé ˜å–å…è²»ç¢ç‰‡3æ¬¡', reward: { stones: 100, fragments: 50 }, status: 'locked', condition: () => fragmentClaims >= 3 },
                'historian': { name: 'æ­·å²å­¸å®¶', description: 'ç´¯è¨ˆæŸ¥çœ‹å¬å–šæ­·å²3æ¬¡', reward: { stones: 50, fragments: 10 }, status: 'locked', condition: () => historyViews >= 3 },
                'theArchivist': { name: 'æª”æ¡ˆç®¡ç†å“¡', description: 'ç´¯è¨ˆæŸ¥çœ‹å¬å–šæ­·å²10æ¬¡', reward: { stones: 100, fragments: 20 }, status: 'locked', condition: () => historyViews >= 10 },
                'stardustHoarder': { name: 'æ˜Ÿå¡µå¯Œç¿', description: 'ç´¯è¨ˆæ“æœ‰è¶…é9000æ˜Ÿå¡µçŸ³', reward: { stones: 150, fragments: 50 }, status: 'locked', condition: () => stardustStones > 9000 },
                'rockBottomLuck': { name: 'å¢Šåº•çš„é‹æ°£', description: 'åœ¨10é€£å¬å–šä¸­åªç²å¾—Nå’ŒRè§’è‰²', reward: { stones: 150, fragments: 50 }, status: 'locked', condition: () => gachaHistory.some(h => h.results.length >= 10 && h.results.every(r => r.rarity === 'N' || r.rarity === 'R')) },
                'fragmentSummoner': { name: 'ç¢ç‰‡å¬å–šå¸«', description: 'ç´¯è¨ˆé€²è¡Œ10æ¬¡ç¢ç‰‡å¬å–š', reward: { stones: 100, fragments: 50 }, status: 'locked', condition: () => fragmentSummons >= 10 },
                'theGambler': { name: 'çœŸæ­£çš„è³­å¾’', description: 'ç´¯è¨ˆé€²è¡Œ50æ¬¡ç¢ç‰‡å¬å–š', reward: { stones: 200, fragments: 100 }, status: 'locked', condition: () => fragmentSummons >= 50 },
                'dailyPersistence': { name: 'æ¯æ—¥çš„å …æŒ', description: 'ç´¯è¨ˆé ˜å–æ¯æ—¥çå‹µ7æ¬¡', reward: { stones: 200, fragments: 50 }, status: 'locked', condition: () => dailyClaims >= 7 },
                'thePatient': { name: 'æœ‰è€å¿ƒçš„äºº', description: 'ç´¯è¨ˆé ˜å–æ¯æ—¥çå‹µ30æ¬¡', reward: { stones: 500, fragments: 100 }, status: 'locked', condition: () => dailyClaims >= 30 },
                'constellationMaster': { name: 'æ˜Ÿåº§å¤§å¸«', description: 'åœ¨å¬å–šå‰ç¹ªè£½ä¸€å€‹è¶…é12å€‹ç¯€é»çš„æ˜Ÿåº§', reward: { stones: 80, fragments: 20 }, status: 'locked', condition: () => maxConstellationPoints >= 12 },
                'starryNight': { name: 'æ˜Ÿç©ºç•«å®¶', description: 'ç¹ªè£½ä¸€å€‹è¶…é20å€‹ç¯€é»çš„æ˜Ÿåº§', reward: { stones: 120, fragments: 30 }, status: 'locked', condition: () => maxConstellationPoints >= 20 },
                'quickDraw': { name: 'é€Ÿæˆ°é€Ÿæ±º', description: 'ç´¯è¨ˆä½¿ç”¨ã€Œè·³éå‹•ç•«ã€åŠŸèƒ½10æ¬¡', reward: { stones: 50, fragments: 10 }, status: 'locked', condition: () => skipAnimationUses >= 10 },
                'bigSpender': { name: 'ä¸€æ“²åƒé‡‘', description: 'ç´¯è¨ˆèŠ±è²»è¶…é50000æ˜Ÿå¡µçŸ³', reward: { stones: 500, fragments: 100 }, status: 'locked', condition: () => totalStonesSpent >= 50000 },
                'abyssStaresBack': { name: 'æ·±æ·µå‡è¦–', description: 'é€£çºŒ3æ¬¡10é€£å¬å–šæœªç²å¾—SSRæˆ–URè§’è‰²', reward: { stones: 100, fragments: 50 }, status: 'locked', condition: () => noSsrStreak >= 3 },
                'puddingEnjoyer': { name: 'å¸ƒä¸æ„›å¥½è€…', description: 'åœ¨å¸ƒä¸ä¸»é¡Œä¸‹é€²è¡Œ10æ¬¡å¬å–š', reward: { stones: 150, fragments: 30 }, status: 'locked', condition: () => pullsInPuddingMode >= 10 },
                'penniless': { name: 'ä¸€è²§å¦‚æ´—', description: 'æ˜Ÿå¡µçŸ³ä½æ–¼80ä¸”ç¢ç‰‡ä½æ–¼120', reward: { stones: 300, fragments: 100 }, status: 'locked', condition: () => stardustStones < 80 && fragments < 120 },
                'fragmentBanker': { name: 'ç¢ç‰‡éŠ€è¡Œå®¶', description: 'ç´¯è¨ˆæ“æœ‰è¶…é10000ç¢ç‰‡', reward: { stones: 300, fragments: 200 }, status: 'locked', condition: () => fragments >= 10000 },
                'pacifist': { name: 'å’Œå¹³ä¸»ç¾©è€…', description: 'ç´¯è¨ˆå¬å–š100æ¬¡ä¸”å¾æœªä½¿ç”¨è·³éåŠŸèƒ½', reward: { stones: 200, fragments: 50 }, status: 'locked', condition: () => totalPulls >= 100 && skipAnimationUses === 0 },
                'allOrNothing': { name: 'å‚¾å®¶è•©ç”¢', description: 'ä¸€æ¬¡æ€§å°‡è¶…é10000çš„æ˜Ÿå¡µçŸ³èŠ±åˆ°ä½æ–¼80', reward: { stones: 300, fragments: 100 }, status: 'locked', condition: () => gachaHistory.some(h => !h.isFragmentPool && h.results.length > 1 && h.startStones > 10000 && h.endStones < 80) },
                'theStrategist': { name: 'ç­–ç•¥å®¶', description: 'åœ¨æ˜Ÿå¡µçŸ³æ°å¥½è¶³å¤ ä¸€æ¬¡åé€£æ™‚å¬å–š(800-879)', reward: { stones: 100, fragments: 20 }, status: 'locked', condition: () => gachaHistory.some(h => !h.isFragmentPool && h.results.length === 10 && h.startStones >= 800 && h.startStones < 880) },
                'starCollector': { name: 'ç¹æ˜Ÿæ”¶è—å®¶', description: 'æ‰€æœ‰è§’è‰²ç¸½æ˜Ÿæ•¸é”åˆ°100', reward: { stones: 500, fragments: 100 }, status: 'locked', condition: () => Object.values(characterCollection).reduce((sum, char) => sum + char.stars, 0) >= 100 },
                'puddingTruth': { name: 'å¸ƒä¸çš„çœŸç†', description: 'å¬å–šåˆ°å‚³èªªä¸­çš„å¸ƒä¸', reward: { stones: 888, fragments: 88 }, status: 'locked', condition: () => rarityCounts.UUR > 0 },
            };
        }
        
        function initializeNewGame() {
            pityCounters = { sr: 0, ssr: 0 };
            rarityCounts = { N: 0, R: 0, SR: 0, SSR: 0, UR: 0, UUR: 0 };
            characterCollection = {};
            gachaHistory = [];
            totalPulls = 0;
            stardustStones = 3000;
            fragments = 0;
            luckCalculations = 0;
            fragmentClaims = 0;
            historyViews = 0;
            infoViews = 0;
            ssrPityTriggered = false;
            fragmentSummons = 0;
            dailyClaims = 0;
            skipAnimationUses = 0;
            totalStonesSpent = 0;
            maxConstellationPoints = 0;
            noSsrStreak = 0;
            pullsInPuddingMode = 0;
            achievements = getInitialAchievements();
        }

        function resetGame() {
            localStorage.removeItem('gachaSimSaveData');
            // 'hasResetOnce' is intentionally not cleared
            initializeNewGame();
            dom.claimDailyBtn.disabled = false;
            dom.claimDailyBtn.textContent = 'æ¯æ—¥é ˜å–';
            dom.canvasContainer.querySelectorAll('.card-on-canvas, #continue-prompt').forEach(el => el.remove());
            dom.canvasOverlay.style.display = 'flex';
            isDrawingAnimation = false;
            if (fragmentClaimIntervalId) clearInterval(fragmentClaimIntervalId);
            startFragmentTimer();
            updateAllUI();
        }

        function saveData() {
            const gameState = { 
                pityCounters, rarityCounts, characterCollection, gachaHistory, totalPulls, stardustStones, fragments, achievements, 
                lastDailyClaim: new Date().toDateString(), luckCalculations, fragmentClaims, historyViews, infoViews, ssrPityTriggered, 
                fragmentSummons, dailyClaims, skipAnimationUses, totalStonesSpent, maxConstellationPoints, noSsrStreak, pullsInPuddingMode
            };
            localStorage.setItem('gachaSimSaveData', JSON.stringify(gameState));
        }
        function loadData() {
            const savedData = localStorage.getItem('gachaSimSaveData');
            if (savedData) {
                const gameState = JSON.parse(savedData);
                pityCounters = gameState.pityCounters;
                rarityCounts = gameState.rarityCounts;
                characterCollection = gameState.characterCollection;
                gachaHistory = gameState.gachaHistory || [];
                totalPulls = gameState.totalPulls;
                stardustStones = gameState.stardustStones;
                fragments = gameState.fragments;
                achievements = { ...getInitialAchievements(), ...gameState.achievements };
                luckCalculations = gameState.luckCalculations || 0;
                fragmentClaims = gameState.fragmentClaims || 0;
                historyViews = gameState.historyViews || 0;
                infoViews = gameState.infoViews || 0;
                ssrPityTriggered = gameState.ssrPityTriggered || false;
                fragmentSummons = gameState.fragmentSummons || 0;
                dailyClaims = gameState.dailyClaims || 0;
                skipAnimationUses = gameState.skipAnimationUses || 0;
                totalStonesSpent = gameState.totalStonesSpent || 0;
                maxConstellationPoints = gameState.maxConstellationPoints || 0;
                noSsrStreak = gameState.noSsrStreak || 0;
                pullsInPuddingMode = gameState.pullsInPuddingMode || 0;

                if(gameState.lastDailyClaim === new Date().toDateString()) {
                    dom.claimDailyBtn.disabled = true;
                    dom.claimDailyBtn.textContent = 'å·²é ˜å–';
                }
            } else {
                initializeNewGame();
            }
        }

        // --- åˆå§‹åŒ– ---
        function init() { 
            loadData();
            resizeCanvas(); 
            generateStars(100); 
            drawStars(); 
            updateAllUI(); 
            populateInfoModal(); 
            setupEventListeners(); 
            setDate(); 
            startFragmentTimer();
            checkAchievements();
        }
        init();
    </script>
</body>
</html>

